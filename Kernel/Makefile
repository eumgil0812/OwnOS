# ğŸ“Œ Toolchain configuration
CC      = x86_64-elf-gcc
LD      = x86_64-elf-ld
CFLAGS  = -ffreestanding -fno-pie -fno-pic -nostdlib -I.
ASFLAGS = $(CFLAGS)
LDFLAGS = -T kernel.ld -nostdlib -no-pie

# ğŸ”¸ object files
OBJS = kernel.o serial.o fb.o font.o font_8x16.o memory.o kprintf.o pmm.o string.o vmm.o \
       idt.o isr.o isr_stubs.o

TARGET  = kernel.elf
SIGNKEY = priv.pem
SIGNOUT = kernel.sig

# ğŸ› ï¸ Default build: build â†’ sign  (cleanì€ í•„ìš”í•  ë•Œë§Œ)
all: $(TARGET) sign

# ğŸ”¸ Compile .c files
%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@

# ğŸ”¸ Compile .S (assembly, GAS) files
%.o: %.S
	$(CC) $(ASFLAGS) -c $< -o $@

# ğŸ”¸ Link
$(TARGET): $(OBJS) kernel.ld
	$(LD) $(LDFLAGS) $(OBJS) -o $(TARGET)
	@echo "âœ… Build complete: $(TARGET)"

# ğŸ” Sign ELF binary
sign: $(TARGET)
	openssl dgst -sha256 -sign $(SIGNKEY) -out $(SIGNOUT) $(TARGET)
	@echo "ğŸ” Signed kernel: $(SIGNOUT)"

# ğŸ§¹ Clean up build artifacts
clean:
	rm -f $(OBJS) $(TARGET) $(SIGNOUT)
	@echo "ğŸ§¹ Clean done"

.PHONY: all clean sign
